<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°å­¦æ•°å­¦åˆ¤å·å°å·¥å…·</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --line:#e7e9f2;
      --text:#1f2430;
      --muted:#667085;
      --brand:#3b82f6;
      --ok:#22c55e;
      --bad:#ef4444;
      --shadow: 0 10px 24px rgba(16,24,40,.08);
      --r:16px;
      --r2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); color:var(--text); background:var(--bg);}
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--r);
      background:var(--panel); box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg, #60a5fa, #2563eb);}
    .brand h1{font-size:15px; margin:0}
    .sub{font-size:12.5px; color:var(--muted); margin-top:2px}
    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background:#fbfcff; color:var(--muted); font-size:12.5px;
    }
    .pill strong{color:var(--text)}
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      padding:9px 12px; border-radius:999px;
      cursor:pointer; font-weight:600; font-size:13px;
      transition:.12s ease;
    }
    .btn.primary{background:var(--brand); border-color:var(--brand); color:#fff;}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0px)}
    input[type="file"]{display:none}

    .grid{display:grid; grid-template-columns: 300px 1fr 330px; gap:14px; margin-top:14px;}
    @media (max-width: 1050px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:14px;}
    .muted{color:var(--muted); font-size:12.5px;}
    .divider{height:1px; background:var(--line); margin:12px 0;}
    .list{display:flex; flex-direction:column; gap:8px; max-height:520px; overflow:auto; padding-right:4px;}
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:#fbfcff;
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .item.active{border-color:rgba(59,130,246,.45); box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted); background:#fff;
      white-space:nowrap;
    }
    .tag.ok{border-color:rgba(34,197,94,.25); color:#15803d}
    .tag.bad{border-color:rgba(239,68,68,.25); color:#b91c1c}
    .qtitle{font-size:13px; line-height:1.3;}
    .qmeta{margin-top:4px; font-size:12px; color:var(--muted); font-family:var(--mono)}
    textarea{
      width:100%; min-height:120px; resize:vertical;
      border:1px solid var(--line); border-radius:14px;
      padding:10px; outline:none; font-size:13px;
      font-family:var(--sans);
      background:#fbfcff;
    }
    .answerBox{
      border:1px dashed rgba(59,130,246,.45);
      background:rgba(59,130,246,.05);
      padding:10px; border-radius:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .answerBox code{font-family:var(--mono); font-size:13px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
    .field label{font-size:12px; color:var(--muted);}
    .scoreInput{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      font-size:14px;
      background:#fbfcff;
    }
    .resultBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      font-size:12.5px; color:var(--muted);
      background:#fff;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:#cbd5e1;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .smallBtn{padding:8px 10px; border-radius:12px; font-size:12.5px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>å°å­¦æ•°å­¦åˆ¤å·å°å·¥å…·</h1>
          <div class="sub">è¾“å…¥å­¦ç”Ÿç­”æ¡ˆ â†’ è‡ªåŠ¨åˆ¤å¯¹é”™ â†’ è®¡åˆ†ä¸å¯¼å‡ºç»“æœ</div>
        </div>
      </div>

      <div class="stats">
        <div class="pill">å·²åˆ¤ï¼š<strong id="doneCount">0</strong> / <strong id="totalCount">0</strong></div>
        <div class="pill">æ€»åˆ†ï¼š<strong id="sumScore">0</strong></div>
        
        <!-- Optimized: Dataset Selector -->
        <select id="datasetSelect" class="btn" style="max-width:160px; text-overflow:ellipsis;">
          <option value="demo">ç¤ºä¾‹é¢˜ç›®</option>
        </select>
        <button class="btn primary" id="btnLoadServer">è½½å…¥é¢˜åº“</button>

        <!-- Less prominent local file import -->
        <label class="btn" for="fileInput" title="å¯¼å…¥æœ¬åœ° JSON æ–‡ä»¶">ğŸ“‚</label>
        <input id="fileInput" type="file" accept=".json" />

        <button class="btn" id="btnExport">å¯¼å‡ºç»“æœ</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: list -->
      <div class="card">
        <h2>é¢˜ç›®åˆ—è¡¨</h2>
        <div class="muted">ç‚¹å‡»åˆ‡æ¢é¢˜ç›®ã€‚ç»¿è‰²=å·²åˆ¤ä¸”æ­£ç¡®ï¼Œçº¢è‰²=å·²åˆ¤ä½†é”™è¯¯ã€‚</div>
        <div class="divider"></div>
        <div class="list" id="qList"></div>
      </div>

      <!-- Middle: question -->
      <div class="card">
        <div class="row" style="align-items:center">
          <div>
            <h2 id="qHeader">å½“å‰é¢˜ç›®</h2>
            <div class="muted" id="qInfo">â€”</div>
          </div>
          <div style="flex:0 0 auto">
            <button class="btn smallBtn" id="btnPrev">ä¸Šä¸€é¢˜</button>
            <button class="btn smallBtn" id="btnNext">ä¸‹ä¸€é¢˜</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>é¢˜å¹²</label>
          <textarea id="qText" readonly></textarea>
        </div>

        <div class="answerBox">
          <div>
            <div class="muted">æ ‡å‡†ç­”æ¡ˆï¼ˆå¯éšè—/æ˜¾ç¤ºï¼‰</div>
            <div><code id="truthText">***</code></div>
          </div>
          <button class="btn smallBtn" id="btnToggleTruth">æ˜¾ç¤º</button>
        </div>

        <div class="divider"></div>

        <div class="muted">
          åˆ¤å·é€»è¾‘ï¼š<br/>
          - åªå¯¹æ¯”â€œæœ€ç»ˆç­”æ¡ˆâ€æ˜¯å¦ç›¸åŒï¼ˆæ”¯æŒ 1/4 = 0.25 è¿™ç§ç®€å•æ•°å€¼ç­‰ä»·ï¼‰<br/>
          - å¯ä»¥æ‰‹åŠ¨æ”¹åˆ†ã€å†™å¤‡æ³¨
        </div>
      </div>

      <!-- Right: grading -->
      <div class="card">
        <h2>åˆ¤å·é¢æ¿</h2>
        <div class="muted">è¾“å…¥å­¦ç”Ÿç­”æ¡ˆ â†’ ç‚¹å‡»â€œåˆ¤å·â€</div>
        
        <!-- AI Toggle -->
        <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="useAI" style="cursor:pointer">
          <label for="useAI" style="cursor:pointer; font-size:13px; color:var(--brand); font-weight:600">âœ¨ å¯ç”¨ AI æ™ºèƒ½åˆ¤å· (Java Agent)</label>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>å­¦ç”Ÿç­”æ¡ˆ</label>
          <input class="scoreInput" id="studentAns" placeholder="ä¾‹å¦‚ï¼š24 / 0.25 / 1/4 / 150 åƒç±³" />
        </div>

        <div class="row">
          <button class="btn primary" id="btnJudge">åˆ¤å·</button>
          <button class="btn" id="btnClearAns">æ¸…ç©º</button>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>åˆ¤å·ç»“æœ</label>
          <div class="resultBadge" id="resultBadge">
            <span class="dot" id="resultDot"></span>
            <span id="resultText">æœªåˆ¤</span>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>å¾—åˆ†ï¼ˆæœ¬é¢˜ï¼‰</label>
            <input class="scoreInput" id="scoreInput" type="number" min="0" step="1" value="0" />
          </div>
          <div class="field">
            <label>æœ¬é¢˜æ»¡åˆ†</label>
            <input class="scoreInput" id="maxScoreInput" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <div class="field">
          <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="noteBox" placeholder="ä¾‹å¦‚ï¼šå•ä½æ²¡å†™ã€ç®—å¼ä¸å®Œæ•´ã€ç²—å¿ƒç®—é”™â€¦"></textarea>
        </div>

        <div class="row">
          <button class="btn" id="btnSave">ä¿å­˜æœ¬é¢˜</button>
          <button class="btn" id="btnResetThis">é‡ç½®æœ¬é¢˜è®°å½•</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== ç®€å•å¯ç”¨ç‰ˆï¼šé¢˜ç›®ç»“æ„ ======
    // { id, text, truth, meta(optional), maxScore(optional) }
    let questions = [];
    let idx = 0;
    let showTruth = false;

    // grading records by id
    const records = new Map(); // id -> {studentAns, isCorrect, score, maxScore, note, judgedAt}

    // ====== Demo ======
    const demo = [
      { id:"Q001", meta:"å››åˆ™è¿ç®— Â· G4", text:"å°æ˜ä¹°äº†4è¢‹è‹¹æœï¼Œæ¯è¢‹6ä¸ªï¼Œä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ", truth:"24", maxScore:1 },
      { id:"Q002", meta:"åº”ç”¨é¢˜ Â· G5", text:"ä¸€è¾†è½¦æ¯å°æ—¶è¡Œé©¶60åƒç±³ï¼Œ2.5å°æ—¶è¡Œé©¶å¤šå°‘åƒç±³ï¼Ÿ", truth:"150", maxScore:1 },
      { id:"Q003", meta:"åˆ†æ•° Â· G6", text:"æŠŠ3/4å‡æœæ±å¹³å‡åˆ†ç»™3ä¸ªäººï¼Œæ¯äººå¤šå°‘å‡ï¼Ÿ", truth:"1/4", maxScore:1 },
      { id:"Q004", meta:"å‡ ä½• Â· G4", text:"é•¿æ–¹å½¢é•¿8å˜ç±³ï¼Œå®½5å˜ç±³ï¼Œå‘¨é•¿æ˜¯å¤šå°‘å˜ç±³ï¼Ÿ", truth:"26", maxScore:1 }
    ];

    // ====== Utils ======
    const $ = (s)=>document.querySelector(s);
    const normalize = (s)=>String(s??"").trim()
      .replace(/\s+/g,"")
      .replace(/[ï¼Œ,ã€‚]/g,"")
      .replace(/^ç­”æ¡ˆ[:ï¼š]/,"")
      .replace(/åƒç±³/g,"").replace(/å…¬é‡Œ/g,"").replace(/å˜ç±³/g,"").replace(/cm/ig,"");

    function fracToNum(s){
      const m = s.match(/^(-?\d+)\s*\/\s*(-?\d+)$/);
      if(!m) return null;
      const a = Number(m[1]), b = Number(m[2]);
      if(!isFinite(a) || !isFinite(b) || b===0) return null;
      return a/b;
    }

    function eqAnswer(a,b){
      const na = normalize(a), nb = normalize(b);
      if(na === nb) return true;

      const fa = fracToNum(na), fb = fracToNum(nb);
      if(fa!=null && fb!=null) return Math.abs(fa-fb) < 1e-9;
      if(fa!=null && isFinite(Number(nb))) return Math.abs(fa-Number(nb)) < 1e-9;
      if(fb!=null && isFinite(Number(na))) return Math.abs(fb-Number(na)) < 1e-9;

      if(isFinite(Number(na)) && isFinite(Number(nb))) return Math.abs(Number(na)-Number(nb)) < 1e-9;
      return false;
    }

    function setBadge(state){
      const dot = $("#resultDot");
      const text = $("#resultText");
      dot.className = "dot";
      if(state==="ok"){ dot.classList.add("ok"); text.textContent="æ­£ç¡®"; }
      else if(state==="bad"){ dot.classList.add("bad"); text.textContent="é”™è¯¯"; }
      else { text.textContent="æœªåˆ¤"; }
    }

    // ====== Render ======
    function renderList(){
      const box = $("#qList");
      box.innerHTML = "";

      questions.forEach((q, i)=>{
        const rec = records.get(q.id);
        const tag = rec
          ? (rec.isCorrect ? `<span class="tag ok">å·²åˆ¤Â·æ­£ç¡®</span>` : `<span class="tag bad">å·²åˆ¤Â·é”™è¯¯</span>`)
          : `<span class="tag">æœªåˆ¤</span>`;

        const el = document.createElement("div");
        el.className = "item" + (i===idx ? " active":"");
        el.innerHTML = `
          <div style="min-width:0">
            <div class="qtitle">${q.id}ï¼š${q.text.slice(0,18)}${q.text.length>18?"â€¦":""}</div>
            <div class="qmeta">${q.meta ?? ""}</div>
          </div>
          <div>${tag}</div>
        `;
        el.onclick = ()=>{ idx=i; loadCurrent(); };
        box.appendChild(el);
      });

      $("#totalCount").textContent = questions.length;
      $("#doneCount").textContent = records.size;
      $("#sumScore").textContent = sumScore();
    }

    function sumScore(){
      let s = 0;
      for(const r of records.values()) s += Number(r.score||0);
      return s;
    }

    function loadCurrent(){
      if(!questions.length){
        $("#qHeader").textContent = "å½“å‰é¢˜ç›®";
        $("#qInfo").textContent = "â€”";
        $("#qText").value = "";
        $("#truthText").textContent = "***";
        $("#studentAns").value = "";
        $("#noteBox").value = "";
        $("#scoreInput").value = 0;
        $("#maxScoreInput").value = 1;
        setBadge("idle");
        renderList();
        return;
      }

      const q = questions[idx];
      $("#qHeader").textContent = `å½“å‰é¢˜ç›®ï¼š${q.id}`;
      $("#qInfo").textContent = q.meta ?? "";
      $("#qText").value = q.text;

      $("#maxScoreInput").value = q.maxScore ?? 1;

      // truth show/hide
      $("#truthText").textContent = showTruth ? q.truth : "***";
      $("#btnToggleTruth").textContent = showTruth ? "éšè—" : "æ˜¾ç¤º";

      // load record if exists
      const rec = records.get(q.id);
      if(rec){
        $("#studentAns").value = rec.studentAns ?? "";
        $("#noteBox").value = rec.note ?? "";
        $("#scoreInput").value = rec.score ?? 0;
        $("#maxScoreInput").value = rec.maxScore ?? ($("#maxScoreInput").value);
        setBadge(rec.isCorrect ? "ok":"bad");
      }else{
        $("#studentAns").value = "";
        $("#noteBox").value = "";
        $("#scoreInput").value = 0;
        setBadge("idle");
      }

      renderList();
    }

    // ====== Actions ======
    $("#btnToggleTruth").onclick = ()=>{
      showTruth = !showTruth;
      loadCurrent();
    };

    $("#btnPrev").onclick = ()=>{
      if(!questions.length) return;
      idx = (idx - 1 + questions.length) % questions.length;
      loadCurrent();
    };

    $("#btnNext").onclick = ()=>{
      if(!questions.length) return;
      idx = (idx + 1) % questions.length;
      loadCurrent();
    };

    // ====== Server Logic ======
    async function initDatasets(){
      try{
        const res = await fetch("/api/datasets");
        if(res.ok){
          const list = await res.json();
          const sel = $("#datasetSelect");
          // Clear and rebuild options
          sel.innerHTML = "";
          
          // Option 1: Demo
          const demoOpt = document.createElement("option");
          demoOpt.value = "demo";
          demoOpt.textContent = "ç¤ºä¾‹é¢˜ç›® (Demo)";
          sel.appendChild(demoOpt);

          // Option 2: Server files
          list.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.id;
            opt.textContent = `${d.name} (${d.group})`;
            sel.appendChild(opt);
          });
          
          // Auto-select first real dataset if available
          if(list.length > 0){
             sel.value = list[0].id;
             // Optional: auto-load it? 
             // $("#btnLoadServer").click(); // Maybe too aggressive
             console.log("Auto-selected:", list[0].id);
          }
        }
      }catch(e){ 
        console.log("Standalone mode or API failed", e);
        const sel = $("#datasetSelect");
        sel.innerHTML = `<option value="demo">âš ï¸ ç¦»çº¿æ¨¡å¼ (ä»…Demo)</option>`;
        alert("æç¤ºï¼šè¯·è¿è¡Œ python app.py æ¥åŠ è½½ data æ–‡ä»¶å¤¹ä¸­çš„é¢˜ç›®ã€‚\nå½“å‰å¤„äºç¦»çº¿/æ–‡ä»¶é¢„è§ˆæ¨¡å¼ï¼Œåªèƒ½çœ‹åˆ°ç¤ºä¾‹é¢˜ç›®ã€‚");
      }
    }

    $("#btnLoadServer").onclick = async ()=>{
      const val = $("#datasetSelect").value;
      if(val === "demo"){
        questions = demo;
        idx = 0;
        records.clear();
        showTruth = false;
        loadCurrent();
        return;
      }
      
      const btn = $("#btnLoadServer");
      const originalText = btn.textContent;
      btn.textContent = "Loadingâ€¦";
      btn.disabled = true;
      try{
        const res = await fetch(`/api/load?id=${encodeURIComponent(val)}`);
        if(!res.ok) throw new Error("Server Error: " + res.status);
        
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("Format Error: Server returned non-array");
        
        questions = data;
        idx = 0;
        records.clear();
        showTruth = false;
        loadCurrent();
        alert(`æˆåŠŸè½½å…¥ ${questions.length} é“é¢˜ç›®ï¼`);
      }catch(e){ 
        alert("è½½å…¥å¤±è´¥: " + e.message); 
      }finally{ 
        btn.textContent = originalText;
        btn.disabled = false;
      }
    };

    $("#btnClearAns").onclick = ()=>{
      $("#studentAns").value = "";
      setBadge("idle");
      $("#scoreInput").value = 0;
    };

    $("#btnJudge").onclick = async ()=>{
      if(!questions.length) return alert("è¯·å…ˆè½½å…¥é¢˜ç›®ï¼ˆç¤ºä¾‹æˆ–å¯¼å…¥ JSONï¼‰ã€‚");
      const q = questions[idx];
      const ans = $("#studentAns").value;
      if(!ans.trim()) return alert("è¯·è¾“å…¥å­¦ç”Ÿç­”æ¡ˆã€‚");

      // Check if AI mode is on
      const useAI = $("#useAI").checked;
      
      if(useAI) {
        // AI Grading
        const btn = $("#btnJudge");
        const originalText = btn.textContent;
        btn.textContent = "AI æ€è€ƒä¸­...";
        btn.disabled = true;
        
        try {
          // Point to Java Backend (now serving on 8080 or same origin if served by Java)
          // Since we moved this HTML to Java static, relative path works!
          const res = await fetch("/api/agent/grade", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
              questionText: q.text,
              standardAnswer: q.truth,
              studentAnswer: ans,
              maxScore: String(q.maxScore ?? 1),
              mode: "review" // Enable Peer Review Mode by default? Or toggle
            })
          });
          
          if(!res.ok) throw new Error("Java Agent Error: " + res.status);
          
          const result = await res.json();
          // Apply AI result
          setBadge(result.correct ? "ok" : "bad");
          $("#scoreInput").value = result.score;
          $("#noteBox").value = (result.reason || "") + "\n(AI åˆ¤å·)";
          
        } catch(e) {
          alert("AI è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Java åç«¯æ˜¯å¦å¯åŠ¨ã€‚\n" + e.message);
          // Fallback to local
          const ok = eqAnswer(ans, q.truth);
          setBadge(ok ? "ok":"bad");
          $("#scoreInput").value = ok ? Number(q.maxScore??1) : 0;
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      } else {
        // Local Grading (Existing Logic)
        const ok = eqAnswer(ans, q.truth);
        setBadge(ok ? "ok":"bad");
        const maxS = Number($("#maxScoreInput").value || (q.maxScore ?? 1));
        $("#scoreInput").value = ok ? maxS : 0;
      }
    };
    
    // Auto-save settings
    $("#useAI").checked = localStorage.getItem("useAI") === "true";
    $("#useAI").onchange = (e) => localStorage.setItem("useAI", e.target.checked);

    $("#btnSave").onclick = ()=>{
      if(!questions.length) return;
      const q = questions[idx];
      const studentAns = $("#studentAns").value;
      const maxScore = Number($("#maxScoreInput").value || (q.maxScore ?? 1));
      const score = Number($("#scoreInput").value || 0);
      const note = $("#noteBox").value;

      // ç”¨å½“å‰ badge åˆ¤æ–­æ˜¯å¦æ­£ç¡®ï¼ˆä¹Ÿå¯ä»¥é‡æ–°ç®—ä¸€éï¼‰
      const isCorrect = eqAnswer(studentAns, q.truth) && score > 0;

      records.set(q.id, {
        studentAns, isCorrect,
        score: Math.max(0, Math.min(score, maxScore)),
        maxScore, note,
        judgedAt: new Date().toISOString()
      });

      loadCurrent();
    };

    $("#btnResetThis").onclick = ()=>{
      if(!questions.length) return;
      const q = questions[idx];
      records.delete(q.id);
      loadCurrent();
    };

    $("#btnExport").onclick = ()=>{
      const payload = {
        exportedAt: new Date().toISOString(),
        totalQuestions: questions.length,
        totalScore: sumScore(),
        records: Array.from(records.entries()).map(([id, r])=>({ id, ...r })),
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "grading_results.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    // import JSON: must be array of questions
    $("#fileInput").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!Array.isArray(data)) throw new Error("JSON é¡¶å±‚å¿…é¡»æ˜¯æ•°ç»„");
        // minimal validation
        questions = data.map((x, i)=>({
          id: x.id ?? `Q${String(i+1).padStart(3,"0")}`,
          text: x.text ?? "",
          truth: x.truth ?? "",
          meta: x.meta ?? "",
          maxScore: x.maxScore ?? 1
        }));
        idx = 0;
        records.clear();
        showTruth = false;
        loadCurrent();
      }catch(err){
        alert("å¯¼å…¥å¤±è´¥ï¼š" + err.message);
      }finally{
        e.target.value = "";
      }
    });

    // init empty
    loadCurrent();
    initDatasets();
  </script>
</body>
</html>
